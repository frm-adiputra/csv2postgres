// Code generated by {{.Generator}} DO NOT EDIT

package main

import (
    "fmt"
    {{- if .HasExport}}
    "os"
    "path/filepath"
    {{- end}}

    {{- if .HasExport}}
    "github.com/joho/sqltocsv"
    {{- end}}
    {{- range .TablesData}}
    "{{.ImportPath}}"
    {{- end}}
    {{- if .ViewsData}}
    "{{$.ImportPath}}/internal/viewsql"
    {{- end}}
)

var (
    {{- range .TablesData}}
    {{.PkgVar}}DB {{.PkgVar}}.DBSynchronizer // {{.RefName}}
    {{- end}}
)

func init() {
    {{- range .TablesData}}
    {{.PkgVar}}DB = {{.PkgVar}}.NewDBSynchronizer()
    {{- end}}
}
{{range .TablesData}}
// {{.TargetName}}Drop drops table {{.RefName}}
func {{.TargetName}}Drop() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{.RefName}}: Dropping table...")
    err = {{.PkgVar}}DB.Drop(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

// {{.TargetName}}DepDrop drops table {{.RefName}} after
// executing all of its dependencies
func {{.TargetName}}DepDrop() {
    {{- if .DropDeps}}
    {{- range .DropDeps}}
    {{.TargetName}}Drop() // {{.RefName}}
    {{- end}}
    {{- end}}
}

// {{.TargetName}}Create creates table {{.RefName}}
func {{.TargetName}}Create() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{.RefName}}: Creating table...")
    err = {{.PkgVar}}DB.Create(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

// {{.TargetName}}DepCreate creates table {{.RefName}} after
// executing all of its dependencies
func {{.TargetName}}DepCreate() {
    {{- if .CreateDeps}}
    {{- range .CreateDeps}}
    {{.TargetName}}Create() // {{.RefName}}
    {{- end}}
    {{- end}}
}

// {{.TargetName}}Delete deletes rows from table {{.RefName}}
func {{.TargetName}}Delete() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{.RefName}}: Deleting table...")
    err = {{.PkgVar}}DB.Delete(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

// {{.TargetName}}DepDelete deletes rows from table {{.RefName}} after
// executing all of its dependencies
func {{.TargetName}}DepDelete() {
    {{- if .DropDepsIncludeTable}}
    {{- range .DropDeps}}
    {{- if .Table}}
    {{.TargetName}}Delete() // {{.RefName}}
    {{- end}}
    {{- end}}
    {{- end}}
}

// {{.TargetName}}Fill fills rows of table {{.RefName}}
func {{.TargetName}}Fill() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{.RefName}}: Filling table...")
    err = {{.PkgVar}}DB.Fill(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Printf(" %d records [OK]\n", {{.PkgVar}}DB.RowCount())
    return nil
}

// {{.TargetName}}DepFill fills rows of table {{.RefName}} after
// executing all of its dependencies
func {{.TargetName}}DepFill() {
    {{- if .CreateDepsIncludeTable}}
    {{- range .CreateDeps}}
    {{- if .Table}}
    {{.TargetName}}Fill() // {{.RefName}}
    {{- end}}
    {{- end}}
    {{- end}}
}

// {{.TargetName}}Up recreates and fill rows of table {{.RefName}}
func {{.TargetName}}Up() {
    {{.TargetName}}DepDrop()
    {{.TargetName}}DepCreate()
    {{.TargetName}}DepFill()
}

// {{.TargetName}}Down drops the table {{.RefName}} and its dependants
func {{.TargetName}}Down() {
    {{.TargetName}}DepDrop() // {{.RefName}}
}
{{- end}}
{{- range .ViewsData}}

// {{.TargetName}}Drop drops view {{.RefName}}
func {{.TargetName}}Drop() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{.RefName}}: Dropping view...")
    _, err = db.Exec(viewsql.{{.TargetName}}Drop)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

// {{.TargetName}}DepDrop drops view {{.RefName}} after
// executing all of its dependencies
func {{.TargetName}}DepDrop() {
    {{- if .DropDeps}}
    {{- range .DropDeps}}
    {{.TargetName}}Drop() // {{.RefName}}
    {{- end}}
    {{- end}}
}

// {{.TargetName}}Create creates view {{.RefName}}
func {{.TargetName}}Create() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{.RefName}}: Creating view...")
    _, err = db.Exec(viewsql.{{.TargetName}}Create)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

// {{.TargetName}}DepCreate creates view {{.RefName}} after
// executing all of its dependencies
func {{.TargetName}}DepCreate() {
    {{- if .CreateDeps}}
    {{- range .CreateDeps}}
    {{.TargetName}}Create() // {{.RefName}}
    {{- end}}
    {{- end}}
}

{{- if .Export}}

// {{.TargetName}}Export exports view's query result to CSV.
func {{.TargetName}}Export() error {
    fmt.Print("{{.RefName}}: Exporting to CSV...")
    dir := filepath.Dir(`{{.Export}}`)
    err := os.MkdirAll(dir, 0777)
	if err != nil {
        fmt.Println("[FAILED]")
		return fmt.Errorf("{{.RefName}} export to CSV: %w", err)
	}

    db, err := newDBConn()
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    defer db.Close()

    rows, err := db.Query(`SELECT * FROM {{.SQLFullName}}`)
    if err != nil {
        fmt.Println("[FAILED]")
        return fmt.Errorf("{{.RefName}} export to CSV: %w", err)
    }
    defer rows.Close()

    err = sqltocsv.WriteFile("{{.Export}}", rows)
    if err != nil {
        fmt.Println("[FAILED]")
        return fmt.Errorf("{{.RefName}} export to CSV: %w", err)
    }
    fmt.Println("[OK]")
    return nil
}
{{- end}}
{{- end}}

// AllUp recreates and fill rows of all tables
func AllUp() {
{{- range .DropDepsAll}}
    {{.TargetName}}Drop() // {{.RefName}}
{{- end}}
{{- range .CreateDepsAll}}
    {{.TargetName}}Create() // {{.RefName}}
{{- end}}
{{- range .CreateDepsAll}}
    {{- if .Table}}
    {{.TargetName}}Fill() // {{.RefName}}
    {{- end}}
{{- end}}
{{- range .CreateDepsAll}}
    {{- if .Export}}
    {{.TargetName}}Export() // {{.RefName}}
    {{- end}}
{{- end}}
}

// AllDown drops all tables and its dependants
func AllDown() {
{{- range .DropDepsAll}}
    {{.TargetName}}Drop() // {{.RefName}}
{{- end}}
}
