// Code generated by {{.Generator}} DO NOT EDIT

// +build mage

package main

import (
    "fmt"

    "github.com/magefile/mage/mg"
    {{- range .Specs}}
    "{{.ImportPath}}"
    {{- end}}
)

var (
    {{- range .Specs}}
    {{.PkgVar}}DB {{.PkgVar}}.DBSynchronizer
    {{- end}}
)

func init() {
    {{- range .Specs}}
    {{.PkgVar}}DB = {{.PkgVar}}.NewDBSynchronizer()
    {{- end}}
}
{{range .Specs}}
type {{upperCaseFirst .Name}} mg.Namespace
{{- end}}
{{range .Specs}}
// Drop drops table {{.Name}}
func (t {{upperCaseFirst .Name}}) Drop() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{upperCaseFirst .Name}}: Dropping table...")
    err = {{.PkgVar}}DB.Drop(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

func (t {{upperCaseFirst .Name}}) depDrop() error {
    {{- if .Dependants}}
    mg.Deps(
        {{- range .Dependants}}
        {{upperCaseFirst .}}.depDrop,
        {{- end}}
    )
    {{- end}}
    return t.Drop()
}

// Create creates table {{.Name}}
func (t {{upperCaseFirst .Name}}) Create() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{upperCaseFirst .Name}}: Creating table...")
    err = {{.PkgVar}}DB.Create(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

func (t {{upperCaseFirst .Name}}) depCreate() error {
    {{- if .DependsOn}}
    mg.Deps(
        {{- range .DependsOn}}
        {{upperCaseFirst .}}.depCreate,
        {{- end}}
    )
    {{- end}}
    return t.Create()
}

// Delete deletes rows from table {{.Name}}
func (t {{upperCaseFirst .Name}}) Delete() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{upperCaseFirst .Name}}: Deleting table...")
    err = {{.PkgVar}}DB.Delete(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Println("[OK]")
    return nil
}

func (t {{upperCaseFirst .Name}}) depDelete() error {
    {{- if .Dependants}}
    mg.Deps(
        {{- range .Dependants}}
        {{upperCaseFirst .}}.depDelete,
        {{- end}}
    )
    {{- end}}
    return t.Delete()
}

// Fill fill rows of table {{.Name}}
func (t {{upperCaseFirst .Name}}) Fill() error {
    db, err := newDBConn()
    if err != nil {
        return err
    }
    defer db.Close()

    fmt.Print("{{upperCaseFirst .Name}}: Filling table...")
    err = {{.PkgVar}}DB.Fill(db)
    if err != nil {
        fmt.Println("[FAILED]")
        return err
    }
    fmt.Printf(" %d records [OK]\n", {{.PkgVar}}DB.RowCount())
    return nil
}

func (t {{upperCaseFirst .Name}}) depFill() error {
    {{- if .DependsOn}}
    mg.Deps(
        {{- range .DependsOn}}
        {{upperCaseFirst .}}.depFill,
        {{- end}}
    )
    {{- end}}
    return t.Fill()
}

// Up recreates and fill rows of table {{.Name}}
func (t {{upperCaseFirst .Name}}) Up() {
    mg.SerialDeps(
        {{upperCaseFirst .Name}}.depDrop,
        {{upperCaseFirst .Name}}.depCreate,
        {{upperCaseFirst .Name}}.depFill,
    )
}

// Down drops the table {{.Name}} and its dependants
func (t {{upperCaseFirst .Name}}) Down() {
    mg.Deps(
        {{upperCaseFirst .Name}}.depDrop,
    )
}
{{- end}}

// AllUp recreates and fill rows of all tables
func AllUp() {
    mg.Deps(
    {{- range .Specs}}
        {{upperCaseFirst .Name}}.Up,
    {{- end}}
    )
}

// AllDown drops all tables and its dependants
func AllDown() {
    mg.Deps(
    {{- range .Specs}}
        {{upperCaseFirst .Name}}.Down,
    {{- end}}
    )
}
